# api_gateway_spring_cloud_gateway.md

## 개요

API 게이트웨이는 클라이언트 요청을 받아서 뒤에 있는 서비스로 보내주는 중간 서버입니다.
서비스가 여러 개로 나뉘면 클라이언트가 모든 서비스를 직접 호출하기가 부담인데, 게이트웨이가 단일 진입점이 되어 그걸 정리해줍니다.

게이트웨이에서 주로 맡는 일은 이런 것들입니다.

* 요청을 어떤 서비스로 보낼지 라우팅
* 인증, 권한 체크 같은 공통 보안 처리
* 로깅, 모니터링
* 요청/응답을 조금 가공하거나 필터링
* 서비스가 여러 인스턴스면 로드 밸런싱까지 같이 처리

---

## Spring Cloud Gateway

Spring Cloud Gateway는 스프링에서 제공하는 API 게이트웨이입니다.
요청 경로를 기준으로 동적으로 라우팅하고, 필터를 통해 요청 전후에 원하는 작업을 끼워 넣을 수 있습니다.

특징은 이 정도로 정리하면 충분합니다.

* URL 패턴 기반 라우팅
* 필터 체인으로 공통 처리 가능
* 로그와 메트릭 기반으로 상태 확인 가능
* Eureka랑 붙이면 서비스 이름 기반 라우팅이 가능함

---

## 라우팅 설정

라우팅은 application.yml에서 정의합니다.

* Path 조건으로 들어온 요청을 어떤 서비스로 보낼지 정합니다.
* uri를 lb://서비스이름 형태로 쓰면, 서비스 디스커버리 기반으로 인스턴스를 골라서 보내줍니다.

예시로 보면 이런 느낌입니다.

* /order/** 는 order-service 로
* /product/** 는 product-service 로

---

## 필터링

필터는 요청 전후에 공통 로직을 넣는 용도입니다.

* Global Filter
  모든 요청에 적용되는 필터
* Gateway Filter
  특정 라우트에만 적용되는 필터

필터 코드에서 자주 보는 객체는 이 3개만 알고 있으면 됩니다.

* ServerWebExchange: 요청/응답을 들고 있는 객체
* GatewayFilterChain: 다음 필터로 넘기는 체인
* Mono<Void>: 비동기 흐름에서 “끝났음”을 표현하는 반환 타입

---

## Pre/Post 필터 감 잡기

* Pre 필터
  요청이 라우팅되기 전에 실행, 보통 요청 로그, 헤더 추가 같은 걸 합니다.
  return chain.filter(exchange)로 다음 단계로 넘깁니다.

* Post 필터
  응답이 내려가기 전에 실행, 체인이 끝난 뒤에 실행해야 해서 then(...)을 붙여서 처리합니다.

---

## Zuul

Zuul은 Spring Boot 2 환경에서 많이 보던 게이트웨이입니다.
Gateway랑 비슷하게 라우팅과 필터 기능을 제공합니다.
지금은 “예전 시스템에서는 Zuul을 쓸 수 있다” 정도로만 알고 있으면 됩니다.

---

## 실습 요약

구성은 이렇게 잡았습니다.

* Eureka 1대
* Gateway 1대
* Order 1개 인스턴스
* Product 2개 인스턴스(포트만 다르게)

확인 포인트는 3가지입니다.

1. gateway로 /order 호출하면 order 서비스로 라우팅된다
2. gateway로 /product를 여러 번 호출하면 product 인스턴스가 번갈아 응답한다
3. gateway 로그에서 Pre/Post 필터가 매 요청마다 실행되는 게 보인다

---

## 용어 정리

| 용어             | 의미                           |
| -------------- | ---------------------------- |
| API Gateway    | 단일 진입점, 요청을 서비스로 라우팅하는 중간 서버 |
| Routing        | 요청을 어떤 서비스로 보낼지 결정           |
| Predicate      | 라우팅 조건(Path 같은 것)            |
| Filter         | 요청/응답 전후에 끼워 넣는 공통 로직        |
| Global Filter  | 전체 요청에 적용되는 필터               |
| Gateway Filter | 특정 라우트에만 적용되는 필터             |
| lb://          | 서비스 디스커버리 기반 로드밸런싱 라우팅       |

---

## 공부하면서 떠올릴 질문

* gateway에서 /product로 들어온 요청이 실제로는 어떤 기준으로 인스턴스를 고를까?
* 필터에서 인증을 처리하면, 서비스 쪽에서는 어떤 검증을 남겨두는 게 좋을까?
* Global Filter와 Gateway Filter는 어떤 기준으로 나누는 게 깔끔할까?
